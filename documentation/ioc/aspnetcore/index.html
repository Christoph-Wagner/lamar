<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8">
        <meta charset="utf-8">
        <meta name="generator" content="Bootply" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <title>Lamar - Integration with ASP.Net Core</title>
        <link href="/lamar/content/bootstrap.min.css" rel="stylesheet" type="text/css" />
        <link href="/lamar/content/prism.css" rel="stylesheet" type="text/css" />
        <link href="/lamar/content/theme.css" rel="stylesheet" type="text/css" />

        <link rel="apple-touch-icon" href="/bootstrap/img/apple-touch-icon.png">
        <link rel="apple-touch-icon" sizes="72x72" href="/bootstrap/img/apple-touch-icon-72x72.png">
        <link rel="apple-touch-icon" sizes="114x114" href="/bootstrap/img/apple-touch-icon-114x114.png">

        <link href="/lamar/content/affix.css" rel="stylesheet" type="text/css" />
    </head>

    <body>

      <a href="https://github.com/jasperfx/Lamar"><img style="z-index: 5000; position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/e7bbb0521b397edbd5fe43e7f760759336b5e05f/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677265656e5f3030373230302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"></a>

      <nav class="navbar navbar-default navbar-fixed-top" role="banner">
      <div class="container">
        <div class="navbar-header">
          <a href="/lamar" class="navbar-brand">Lamar</a>
        </div>
        <nav class="collapse navbar-collapse" role="navigation">
          <ul class="nav navbar-nav pull-right">
            <li>
              <a href="/lamar/getting_started">Getting Started</a>
            </li>
            <li>
              <a href="/lamar/documentation">Documentation</a>
            </li>
            <li>
              <a href="https://gitter.im/jasperfx/Lamar?utm_source=badge&amp;utm_medium=badge&amp;utm_campaign=pr-badge&amp;utm_content=badge"><img src="https://camo.githubusercontent.com/da2edb525cde1455a622c58c0effc3a90b9a181c/68747470733a2f2f6261646765732e6769747465722e696d2f4a6f696e253230436861742e737667" alt="Join the chat at https://gitter.im/jasperfx/Lamar" data-canonical-src="https://badges.gitter.im/Join%20Chat.svg" style="max-width:100%;"></a>
            </li>
            <li><a href="/lamar/documentation/ioc/bootstrapping" title="Bootstrapping a Container">Previous</a></li>
            <li><a href="/lamar/documentation/ioc/registration" title="Registration">Next</a></li>
          </ul>
          <div class="navbar-form navbar-left" role="search">
            <div class="form-group">
              <input id="search" type="search" class="form-control" placeholder="Search">
            </div>
          </div>

        </nav>

      </div>
    </nav>

    <div class="container">
      <nav class="navbar-inverse">
        <ol class="breadcrumb"><li><a href="/lamar/">Lamar</a></li><li><a href="/lamar/documentation">Documentation</a></li><li><a href="/lamar/documentation/ioc">Lamar as IoC Container</a></li><li class="active">Integration with ASP.Net Core</li></ol>
      </nav>
    </div>

    <!--main-->
    <div class="container">
      <div class="row">
          <!--left-->
          <div class="col-md-3" id="leftCol">
            <h3>Lamar 4.3.0</h3>
            <br />

            <ul class="nav nav-stacked affix" id="sidebar">
            </ul>

            <h3 class="no-margin">Next</h3><p><a href="/lamar/documentation/ioc/registration">Registration</a></p>
            <h3 class="no-margin">Previous</h3><a href="/lamar/documentation/ioc/bootstrapping">Bootstrapping a Container</a></p>
          </div><!--/left-->

          <!--right-->
          <div class="col-md-9">
              <h1>Integration with ASP.Net Core</h1>

              <hr />

              <div id="main-pane">
                <!--title:Integration with ASP.Net Core-->
<div class="alert-info alert"><p><strong>Note!</strong>
As of Lamar.Microsoft.DependencyInjection 4.0, Lamar successfully support .Net Core 3 and ASP.Net Core 3.0.</p>
</div>
<p>To use Lamar within ASP.Net Core applications, also install the <a href="https://www.nuget.org/packages/Lamar.Microsoft.DependencyInjection/">Lamar.Microsoft.DependencyInjection</a> library from Nuget to your ASP.Net Core project (and you can thank Microsoft for the clumsy naming convention, thank you).</p>
<p>With that Nuget installed, your normal ASP.Net Core bootstrapping changes just slightly. When you bootstrap your <code>IWebHostBuilder</code> object
that configures ASP.Net Core, you also need to call the <code>UseLamar()</code> method as shown below:</p>
<pre><code class="language-csharp">&#xA;public static void Main(string[] args)&#xA;{&#xA;    var builder = new WebHostBuilder();&#xA;    builder&#xA;        // Replaces the built in DI container&#xA;        // with Lamar&#xA;        .UseLamar()&#xA;        &#xA;        // Normal ASP.Net Core bootstrapping&#xA;        .UseUrls(&quot;http://localhost:5002&quot;)&#xA;        .UseKestrel()&#xA;        .UseStartup&lt;Startup&gt;();&#xA;&#xA;    builder.Start();&#xA;&#xA;}&#xA;</code></pre>
<div class="alert-warning alert"><p><strong>Note!</strong>
The <code>Startup.ConfigureServices(ServiceRegistry)</code> convention does not work as of ASP.Net Core 2.1. Use <code>ConfigureContainer(ServiceRegistry)</code> instead.</p>
</div>
<p>If you use a <code>StartUp</code> class for extra configuration, your <code>ConfigureContainer()</code> method <em>can</em> take in a <code>ServiceRegistry</code> object from Lamar for service registrations in place of the ASP.Net Core <code>IServiceCollection</code> interface as shown below:</p>
<pre><code class="language-csharp">&#xA;public class Startup&#xA;{&#xA;    // Take in Lamar&#x27;s ServiceRegistry instead of IServiceCollection&#xA;    // as your argument, but fear not, it implements IServiceCollection&#xA;    // as well&#xA;    public void ConfigureContainer(ServiceRegistry services)&#xA;    {&#xA;        // Supports ASP.Net Core DI abstractions&#xA;        services.AddMvc();&#xA;        services.AddLogging();&#xA;        &#xA;        // Also exposes Lamar specific registrations&#xA;        // and functionality&#xA;        services.Scan(s =&gt;&#xA;        {&#xA;            s.TheCallingAssembly();&#xA;            s.WithDefaultConventions();&#xA;        });&#xA;    }&#xA;&#xA;    public void Configure(IApplicationBuilder app)&#xA;    {&#xA;        app.UseMvc();&#xA;    }&#xA;}&#xA;</code></pre>
<p>You can also still write <code>ConfigureServices(IServiceCollection)</code>, but you'd miss out on most of Lamar's extra functionality beyond what that abstraction
provides.</p>
<p>And that is that, you're ready to run your ASP.Net Core application with Lamar handling service resolution and object cleanup during your
HTTP requests.</p>
<h2 id="asp.net-core-v3">ASP.Net Core v3.*</h2>
<p>The set up with ASP.Net Core v3 isn't really any different, but there's a known <em>gotcha</em> with the <code>AddControllers()</code> call as shown below:</p>
<pre><code class="language-csharp">&#xA;public class Program&#xA;{&#xA;    public static void Main(string[] args)&#xA;    {&#xA;        CreateHostBuilder(args).Build().Run();&#xA;    }&#xA;&#xA;    public static IHostBuilder CreateHostBuilder(string[] args) =&gt;&#xA;        Host.CreateDefaultBuilder(args)&#xA;            &#xA;            // Add Lamar&#xA;            .UseLamar()&#xA;            &#xA;            &#xA;            &#xA;            .ConfigureWebHostDefaults(webBuilder =&gt;&#xA;            {&#xA;                webBuilder.UseStartup&lt;Startup&gt;();&#xA;&#xA;                webBuilder.ConfigureServices(services =&gt;&#xA;                {&#xA;                    // This is important, the call to AddControllers()&#xA;                    // cannot be made before the usage of ConfigureWebHostDefaults&#xA;                    services.AddControllers();&#xA;                });&#xA;            });&#xA;}&#xA;</code></pre>
<p>To play it safe, add any registrations or configuration directly related to MVC Core directly within or after the call to <code>IHostBuilder.ConfigureWebHostDefaults()</code>. This is strictly an issue with ordering within MVC Core guts, and not particularly a problem with Lamar per se.</p>
<h2 id="worker-service-core-v3">Worker Service Core v3.*</h2>
<p>To set up for a worker service, you'll use the same ConfigureContainer() albeit with a different signature.</p>
<pre><code class="language-csharp">&#xA;&#x9;&#x9;public static IHostBuilder CreateHostBuilder(string[] args) =&gt;&#xA;&#x9;&#x9;&#x9;Host.CreateDefaultBuilder(args)&#xA;&#x9;&#x9;&#x9;&#x9;.UseLamar()&#xA;&#x9;&#x9;&#x9;&#x9;.ConfigureServices((hostContext, services) =&gt;&#xA;&#x9;&#x9;&#x9;&#x9;{&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;services.AddHostedService&lt;Worker&gt;();&#xA;&#x9;&#x9;&#x9;&#x9;})&#xA;&#x9;&#x9;&#x9;&#x9;.ConfigureContainer&lt;Lamar.ServiceRegistry&gt;((context, services) =&gt;&#xA;&#x9;&#x9;&#x9;&#x9;{&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;// Also exposes Lamar specific registrations&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;// and functionality&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;services.Scan(s =&gt;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;{&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;s.TheCallingAssembly();&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;s.WithDefaultConventions();&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;});&#xA;&#x9;&#x9;&#x9;&#x9;});&#xA;</code></pre>
<h2 id="extended-command-line-diagnostics-for-asp.net-core">Extended Command Line Diagnostics for ASP.Net Core</h2>
<div class="alert-info alert"><p><strong>Note!</strong>
If you are targeting .Net Core 3.0 and/or <code>netstandard2.1</code>, use the newly consolidated <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/host/generic-host?view=aspnetcore-3.0">HostBuilder</a> instead of the previous <code>IWebHostBuilder</code>.</p>
</div>
<p>New with the Lamar 3.1.0 release is a separate Nuget package named <em>Lamar.Diagnostics</em> that can be used to add easy access to the <a href="/lamar/documentation/ioc/diagnostics">Lamar diagnostics</a> for your ASP.Net Core application from the command line.</p>
<p>First, you need to be using the <a href="https://jasperfx.github.io/oakton/documentation/aspnetcore/">Oakton.AspNetCore</a> package to execute commands in your ASP.Net Core application like this:</p>
<pre><code class="language-csharp">&#xA;var registry = new ServiceRegistry();&#xA;registry.Scan(x =&gt;&#xA;{&#xA;    x.Assembly(typeof(Program).Assembly);&#xA;    x.WithDefaultConventions();&#xA;});&#xA;&#xA;var builder = new WebHostBuilder();&#xA;return builder&#xA;    // Replaces the built in DI container&#xA;    // with Lamar&#xA;    .UseLamar(registry)&#xA;&#xA;    // Normal ASP.Net Core bootstrapping&#xA;    .UseUrls(&quot;http://localhost:5002&quot;)&#xA;    .UseKestrel()&#xA;    .UseStartup&lt;Startup&gt;()&#xA;    .RunOaktonCommands(args);&#xA;</code></pre>
<p>Including this <em>Lamar.Diagnostics</em> Nuget into your ASP.Net Core application will add some additional Lamar diagnostic commands. If you open a command line tool to the root directory of your ASP.Net Core project
with the <em>Lamar.Diagnostics</em> and <em>Oakton.AspNetCore</em> Nuget installed and type the command for CLI usage <code>dotnet run -- ?</code> or <code>dotnet run -- help</code>, you'll get something like this:</p>
<pre><code>Searching 'Lamar.Diagnostics, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null' for commands

  -----------------------------------------------------------------------------------
    Available commands:
  -----------------------------------------------------------------------------------
         check-env -&gt; Execute all environment checks against the application
    lamar-scanning -&gt; Runs Lamar's type scanning diagnostics
    lamar-services -&gt; List all the registered Lamar services
    lamar-validate -&gt; Runs all the Lamar container validations
               run -&gt; Runs the configured AspNetCore application
  -----------------------------------------------------------------------------------
</code></pre>
<p>As you can see, there are three additional commands specific for the <a href="/lamar/documentation/ioc/diagnostics">built in Lamar diagnostics</a>. All of these commands support the <a href="https://jasperfx.github.io/oakton/documentation/aspnetcore/">Oakton.AspNetCore</a> flags for overriding the ASP.Net Core hosting environment name, configuration settings, and default log level.</p>
<div class="alert-info alert"><p><strong>Note!</strong>
When all of these commands execute, they <em>do</em> build the underlying <code>IWebHost</code> for your application, but they do <strong>not</strong> start the Kestrel server or run any of your application <code>IHostedService</code> registrations. Your application will be
torn down and disposed as part of the command execution as well.</p>
</div>
<h2 id="lamar-services">lamar-services</h2>
<p>This command displays the output of Lamar's <a href="/lamar/documentation/ioc/diagnostics/whatdoihave">WhatDoIHave()</a> function against the underlying Lamar container of the configured ASP.Net Core application. The basic usage is <code>dotnet run -- lamar-services</code>.</p>
<p>The full usage is shown below:</p>
<pre><code> Usages for 'lamar-services' (List all the registered Lamar services)
  lamar-services [-f, --file &lt;file&gt;] [-n, --namespace &lt;namespace&gt;] [-a, --assembly &lt;assembly&gt;] [-t, --type &lt;type&gt;] [-b, --build-plans] [-e, --environment &lt;environment&gt;] [-v, --verbose] [-l, --log-level &lt;logleve&gt;] [----config:&lt;prop&gt; &lt;value&gt;]

  ----------------------------------------------------------------------------------------------------------------------------------------
    Flags
  ----------------------------------------------------------------------------------------------------------------------------------------
                  [-f, --file &lt;file&gt;] -&gt; Optional file to write the results
        [-n, --namespace &lt;namespace&gt;] -&gt; Optionally filter the results to only types in this namespace
          [-a, --assembly &lt;assembly&gt;] -&gt; Optionally filter the results to only types in this assembly
                  [-t, --type &lt;type&gt;] -&gt; Optionally filter the results to only this named type. Can be either a type name or a full name
                  [-b, --build-plans] -&gt; Show the full build plans
    [-e, --environment &lt;environment&gt;] -&gt; Use to override the ASP.Net Environment name
                      [-v, --verbose] -&gt; Write out much more information at startup and enables console logging
          [-l, --log-level &lt;logleve&gt;] -&gt; Override the log level
          [----config:&lt;prop&gt; &lt;value&gt;] -&gt; Overwrite individual configuration items
  ----------------------------------------------------------------------------------------------------------------------------------------
</code></pre>
<p>The output can be filtered by using the <code>--namespace [namespace name]</code> or <code>--assembly [assembly name]</code> flags if you're only looking for certain registrations.
The <code>--type [type name]</code> flag can help you look for specific types. This flag can either match against a type's full name or just the type name and looks for both service types and implementation types.</p>
<p>You can write the results to a text file instead by specifying a file location with the <code>--file [file name]</code> flag.</p>
<p>Lastly, you can instead write out the <a href="/lamar/documentation/ioc/diagnostics/build-plans">Build Plans</a> with the same filtering options using the <code>--build-plans</code> flag.</p>
<h2 id="lamar-scanning">lamar-scanning</h2>
<p>The <code>lamar-scanning</code> command gives you quick access to the <a href="/lamar/documentation/ioc/diagnostics/type-scanning">Type Scanning Diagnostics</a> functionality in Lamar.</p>
<p>Using the command <code>dotnet run -- lamar-scanning</code> command on the sample application shown earlier in this page results in this output:</p>
<pre><code>Searching 'Lamar.Diagnostics, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null' for commands
All Scanners
================================================================

Assemblies
----------
* SampleWebApp, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null

Conventions
--------
* Default I[Name]/[Name] registration convention


No problems were encountered in exporting types from Assemblies
</code></pre>
<p>Any type scanning errors detected during application bootstrapping will be shown in the output. If there are any errors, this command will fail by returning a non-zero
return code. You could use this command as part of your continuous integration process to catch any kind of assembly loading problems found in type scanning.</p>
<h2 id="lamar-validate">lamar-validate</h2>
<p>The <code>lamar-validate</code> command will build your ASP.Net Core application (the <code>IWebHost</code>), then use Lamar's <a href="/lamar/documentation/ioc/diagnostics/validating-container-configuration">built in container validation</a> to verify
that the container can successfully build all known registrations. All validation errors will be reported, and the command will fail if there are any errors detected. This command can be used in continuous integration builds as another type of check on the system.</p>
<p>In its default usage, <code>dotnet run -- lamar-validate</code> will only validate the container configuration. If you use the <code>dotnet run -- lamar-validate Full</code> usage, the command will also execute any Lamar <a href="/lamar/documentation/ioc/diagnostics/environment-tests">Environment Tests</a>.</p>
<h2 id="adding-lamar-environment-checks">Adding Lamar Environment Checks</h2>
<p>You can also add Lamar's container validation and its own environment tests to the <em>Oakton.AspNetCore</em> environment check functionality with the following usage of the <code>IServiceCollection.CheckLamarConfiguration()</code> extension method from <em>Lamar.Diagnostics</em> as shown below
in a sample <code>Startup.ConfigureContainer()</code> method:</p>
<pre><code class="language-csharp">&#xA;public class Startup&#xA;{&#xA;    // Take in Lamar&#x27;s ServiceRegistry instead of IServiceCollection&#xA;    // as your argument, but fear not, it implements IServiceCollection&#xA;    // as well&#xA;    public void ConfigureContainer(ServiceRegistry services)&#xA;    {&#xA;        // Supports ASP.Net Core DI abstractions&#xA;        services.AddMvc();&#xA;        services.AddLogging();&#xA;&#xA;        // Also exposes Lamar specific registrations&#xA;        // and functionality&#xA;        services.Scan(s =&gt;&#xA;        {&#xA;            s.TheCallingAssembly();&#xA;            s.WithDefaultConventions();&#xA;        });&#xA;        &#xA;        &#xA;        // This adds Lamar&#x27;s validation to the &#xA;        // Oakton.AspNetCore environment check support&#xA;        services.CheckLamarConfiguration();&#xA;    }&#xA;&#xA;    public void Configure(IApplicationBuilder app)&#xA;    {&#xA;        app.UseMvc();&#xA;    }&#xA;}&#xA;</code></pre>
<p>Now, when you run the <code>dotnet run -- check-env</code> command for your application, you <em>should</em> see a check for the Lamar container:</p>
<pre><code>Searching 'Lamar.Diagnostics, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null' for commands
Running Environment Checks
   1.) Success: Lamar IoC Service Registrations
All environment checks are good!

</code></pre>

              </div>

              <hr />

              <nav>
                <span>
                  <strong>Previous: </strong><a href="/lamar/documentation/ioc/bootstrapping">Bootstrapping a Container</a>

                </span>
                <span class="pull-right">

                  <strong>Next: </strong><a href="/lamar/documentation/ioc/registration">Registration</a>

                </span>
              </nav>

          </div><!--/right-->
        </div><!--/row-->
      </div><!--/container-->

    </body>


    <footer>
        <script type='text/javascript' src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
        <script type='text/javascript' src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

        <script type="text/javascript" src="/lamar/content/prism.js"></script>
        <script type="text/javascript" src="/lamar/content/sidebar.js"></script>
        <script type="text/javascript" src="/lamar/content/affix.js"></script>

<script>
$('#search').keyup(function(e){
  if(e.keyCode == 13) {
    var search = $('#search').val();

    var url = 'https://www.google.com/#q=site:jasperfx.github.io ' + search;
    url = encodeURI(url);

    window.location.href = url;

    e.stopPropagation();
    if (e.cancelBubble!=null) e.cancelBubble = true;
    return false;
  }
});
</script>
    </footer>
</html>
